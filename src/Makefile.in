CC=@CC@
SWIG=@SWIG@
PYDEV=@PYDEV@
PYLIB=@PYLIB@
SONAME=@SONAME@
FRAMEWORK=@FRAMEWORK@
BUILD=@BUILD@
LDFLAGS=@LDFLAGS@
CFLAGS=@CFLAGS@
LIBFTDI1=@LIBFTDI1@
prefix=@prefix@
exec_prefix=@exec_prefix@
LIBDIR=@libdir@
INCDIR=@includedir@
INC=$(PYDEV)
LIB=$(PYLIB)
pythondir=@pythondir@
pkgpythondir=@pkgpythondir@
pyexecdir=@pyexecdir@
pkgpyexecdir=@pkgpyexecdir@
TARGET=mpsse

all: $(TARGET) py$(BUILD)-build

$(TARGET): mpsse.o fast.o
	$(CC) $(CFLAGS) -shared -Wl,$(SONAME),lib$(TARGET).so $(TARGET).o fast.o support.o \
		-o lib$(TARGET).so $(LDFLAGS)
	ar rcs lib$(TARGET).a $(TARGET).o fast.o support.o

example-code:
	make -C examples

mpsse.o: support.o
	$(CC) $(CFLAGS) -DLIBFTDI1=$(LIBFTDI1) -c mpsse.c

fast.o: support.o
	$(CC) $(CFLAGS) -DLIBFTDI1=$(LIBFTDI1) -c fast.c

support.o:
	$(CC) $(CFLAGS) -DLIBFTDI1=$(LIBFTDI1) -c support.c

pyswig-build:
	$(CC) $(CFLAGS) -DSWIGPYTHON -DLIBFTDI1=$(LIBFTDI1) -c support.c -o pyswig_support.o
	$(CC) $(CFLAGS) -DSWIGPYTHON -DLIBFTDI1=$(LIBFTDI1) -c mpsse.c -o pyswig_mpsse.o
	$(SWIG) -python $(TARGET).i
	$(CC) $(CFLAGS) -c  -DLIBFTDI1=$(LIBFTDI1) $(TARGET)_wrap.c  $(INC)
	$(CC) $(CFLAGS) -shared $(FRAMEWORK) $(TARGET)_wrap.o pyswig_mpsse.o pyswig_support.o \
		-o _pylib$(TARGET).so $(LDFLAGS) $(LIB)

pyswig-install:
	install -d -m755 $(DESTDIR)/$(pythondir)
	install -d -m755 $(DESTDIR)/$(pyexecdir)
	install -m644 pylib$(TARGET).py  $(DESTDIR)/$(pythondir)/pylib$(TARGET).py
	install -m644 _pylib$(TARGET).so $(DESTDIR)/$(pyexecdir)/_pylib$(TARGET).so
	install -m644 $(TARGET).py       $(DESTDIR)/$(pythondir)/$(TARGET).py

pyswig-uninstall:
	rm -f $(DESTDIR)/$(pythondir)/$(TARGET).* \
		$(DESTDIR)/$(pythondir)/pylib$(TARGET).* \
		$(DESTDIR)/$(pyexecdir)/_pylib$(TARGET).*

# Dummy rules for when $BUILD == "" (if --disable-python was passed to ./configure)
py-build:
py-install:
py-uninstall:

install: py$(BUILD)-install
	install -d -m755 $(DESTDIR)/$(LIBDIR) $(DESTDIR)/$(INCDIR)
	install -m644 $(TARGET).h     $(DESTDIR)/$(INCDIR)/$(TARGET).h
	install -m644 lib$(TARGET).so $(DESTDIR)/$(LIBDIR)/lib$(TARGET).so
	install -m644 lib$(TARGET).a  $(DESTDIR)/$(LIBDIR)/lib$(TARGET).a
	install -m644 $(TARGET).h     $(DESTDIR)/$(INCDIR)/$(TARGET).h

uninstall: py$(BUILD)-uninstall
	rm -f $(DESTDIR)/$(LIBDIR)/lib$(TARGET).so \
		$(DESTDIR)/$(LIBDIR)/lib$(TARGET).a \
		$(DESTDIR)/$(INCDIR)/$(TARGET).h

clean:
	make -C examples clean
	rm -rf *.o *.so *.a _$(TARGET).py* pylib$(TARGET).py* $(TARGET)_wrap.c *.pyc

distclean: clean
	rm -rf *.cache config.* Makefile

